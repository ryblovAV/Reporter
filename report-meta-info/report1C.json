{
  "title": "Сверка с 1С",
  "sql": [
    "select substr(c1.id_kl, 1, 2) as code_base,",
    "       c1.id_kl as id_kl_1c,",
    "       sa_type_cd,",
    "       acct_id,",
    "       (select b.bill_id",
    "          from rusadm.ci_bill b",
    "         where b.acct_id = t.acct_id",
    "           and trunc(nvl(b.bill_dt, b.cre_dttm)) = trunc(last_day(to_date('01.04.2016', 'DD.MM.YYYY'))) and b.bill_stat_flg = 'P') as bill_id,",
    "       (select entity_name",
    "          from rusadm.ci_per_name pn",
    "         where pn.per_id = t.per_id",
    "           and pn.prim_name_sw = 'Y') as name,",
    "       t.id_kl id_kl_ccb,",
    "       c1.adj_summ,",
    "       t.adj_summ_ccb,",
    "       nvl(c1.adj_summ,0) - nvl(t.adj_summ_ccb,0) as d_adj_summ,",
    "       c1.bseg_summ,",
    "       t.bseg_summ_ccb2,",
    "       nvl(c1.bseg_summ,0) - nvl(t.bseg_summ_ccb2,0) as d_bseg_summ,",
    "       c1.pay_summ,",
    "       t.pay_summ_ccb,",
    "       nvl(c1.pay_summ,0) - nvl(t.pay_summ_ccb,0) as d_pay_summ,",
    "       c1.summ,",
    "       (nvl(adj_summ_ccb, 0) + nvl(bseg_summ_ccb2, 0) - nvl(pay_summ_ccb, 0)) as summ_ccb,",
    "       c1.summ - (nvl(adj_summ_ccb, 0) + nvl(bseg_summ_ccb2, 0) - nvl(pay_summ_ccb, 0)) as d_summ,",
    "       t.kwt as ccb_kwt,",
    "       c1.kwh as lesk_kwt,",
    "       nvl(t.kwt,0) - nvl(c1.kwh,0) as d_kwt",
    "  from leskdata2.cm_from_1c_april c1,",
    "       (select t.id_kl,",
    "               a.acct_id,",
    "               t.per_id,",
    "               (select sa.sa_type_cd from rusadm.ci_sa sa where sa.acct_id = a.acct_id and sa.sa_type_cd = 'L_EL_INT' and rownum = 1) as sa_type_cd,",
    "               (select sum(t.bill_sq)",
    "                  from rusadm.ci_bseg_sq t,",
    "                       rusadm.ci_bseg bs,",
    "                       rusadm.ci_sa sa",
    "                 where t.uom_cd = 'KWH'",
    "                   and t.sqi_cd = 'FULL_FLO'",
    "                   and t.bseg_id = bs.bseg_id",
    "                   and bs.sa_id = sa.sa_id",
    "                   and trunc(bs.end_dt, 'MM') = to_date('01.04.2016', 'DD.MM.YYYY')",
    "                   and sa.acct_id = a.acct_id) as kwt,",
    "               (select sum(ft.tot_amt)",
    "                  from rusadm.ci_ft ft, rusadm.ci_sa sa",
    "                 where ft.sa_id = sa.sa_id",
    "                   and (ft.ft_type_flg in ('BS', 'BX') or (ft.ft_type_flg in ('AD', 'AX') and ft.parent_id != 'VOZVRAT'))",
    "                   and ft.accounting_dt between to_date('01.04.2016', 'DD.MM.YYYY') and add_months(to_date('01.04.2016', 'DD.MM.YYYY'),1) - 1 / 24 / 60 / 60",
    "                and sa.acct_id = a.acct_id) as bseg_summ_ccb2,",
    "               (select nvl(sum(bsc.calc_amt),0)",
    "                  from rusadm.ci_bseg      bs,",
    "                       rusadm.ci_bseg_calc bsc,",
    "                       rusadm.ci_sa        sa",
    "                 where bs.sa_id = sa.sa_id",
    "                   and bsc.bseg_id = bs.bseg_id",
    "                   and trunc(bs.end_dt, 'MM') = trunc(to_date('01.04.2016', 'DD.MM.YYYY'),'MM')",
    "                   and sa.acct_id = a.acct_id) as bseg_summ_ccb,",
    "               (select nvl(sum(-ft.tot_amt),0)",
    "                  from rusadm.ci_ft ft, rusadm.ci_sa sa",
    "                 where ft.sa_id = sa.sa_id",
    "                   and (ft.ft_type_flg in ('PS', 'PX') or (ft.ft_type_flg in ('AD', 'AX') and ft.parent_id = 'VOZVRAT'))",
    "                   and ft.accounting_dt between to_date('01.04.2016', 'DD.MM.YYYY') and add_months(to_date('01.04.2016', 'DD.MM.YYYY'),1) - 1 / 24 / 60 / 60",
    "                  and sa.acct_id = a.acct_id) as pay_summ_ccb,",
    "               (select sum(ft.tot_amt)",
    "                  from rusadm.ci_ft ft, rusadm.ci_sa sa",
    "                 where ft.sa_id = sa.sa_id",
    "                   and ft.accounting_dt < to_date('01.04.2016', 'DD.MM.YYYY')",
    "                   and sa.acct_id = a.acct_id) as adj_summ_ccb,",
    "               (select sum(ft.tot_amt)",
    "                  from rusadm.ci_ft ft, rusadm.ci_sa sa",
    "                 where ft.sa_id = sa.sa_id",
    "                   and ft.accounting_dt <add_months(to_date('01.04.2016', 'DD.MM.YYYY'),1)",
    "                   and sa.acct_id = a.acct_id) as summ_ccb",
    "          from leskdata2.v_kl_acct t, rusadm.ci_acct a",
    "         where a.acct_id = t.acct_id) t",
    " where t.id_kl(+) = c1.id_kl",
    " order by c1.id_kl desc"
  ]
}
